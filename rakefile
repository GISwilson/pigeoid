require 'albacore'

def extract_assembly_version(filePath)
	File.open(filePath,'r') do |file|
		file.each_line do |line|
			current_line = line.strip
			line_match = /.*AssemblyVersion[(]\s*\"(\d+[.]\d+[.]\d+)[.].*\".*/.match(current_line)
			if(line_match) then return line_match[1] end
		end
	end
	nil
end

task :default => [:build,:make_nupkg]

task :make_nupkg => [:make_nupkg_core,:make_nupkg_generation]

task :push_nupkg => [:push_nuget_core,:push_nuget_epsg]

msbuild :build do |msb|
	msb.targets = [:Clean, :Build]
	msb.solution = "./pigeoid-all.sln"
	msb.properties = {:configuration => :Release}
end

exec :make_nupkg_core do |cmd|
	asmVersion3 = extract_assembly_version "./src/PigeoidAssemblyInfo.cs"
	puts "Version: #{asmVersion3}"
	cmd.command = "./.nuget/nuget.exe"
	cmd.parameters = "pack build/pigeoid.nuspec -Verbosity detailed -Version #{asmVersion3} -Symbols -OutputDirectory ./build/packed/ -Properties Configuration=Release"
end

exec :make_nupkg_generation do |cmd|
	asmVersion3 = extract_assembly_version "./src/PigeoidAssemblyInfo.cs"
	cmd.command = "./.nuget/nuget.exe"
	cmd.parameters = "pack build/pigeoid.epsg.nuspec -Verbosity detailed -Version #{asmVersion3} -Symbols -OutputDirectory ./build/packed/ -Properties Configuration=Release"
end

exec :push_nuget_core do |cmd|
	asmVersion3 = extract_assembly_version "./src/PigeoidAssemblyInfo.cs"
	cmd.command = "./.nuget/nuget.exe"
	cmd.parameters = "push build/packed/Pigeoid.Core.#{asmVersion3}.nupkg"
end

exec :push_nuget_epsg do |cmd|
	asmVersion3 = extract_assembly_version "./src/PigeoidAssemblyInfo.cs"
	cmd.command = "./.nuget/nuget.exe"
	cmd.parameters = "push build/packed/Pigeoid.Epsg.#{asmVersion3}.nupkg"
end